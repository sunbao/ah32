# 🚀 Ah32 启动指南

## 准备工作（首次）

- 创建本地配置：`cp .env.example .env`（Windows: `copy .env.example .env`），并在 `.env` 中填写 `DEEPSEEK_API_KEY=...`（或 `AH32_OPENAI_API_KEY=...`）
- 建议使用虚拟环境：Linux/macOS 用 `.venv/bin/python` / `.venv/bin/pip`；Windows 用 `.venv\\Scripts\\python` / `.venv\\Scripts\\pip`

> 说明：后端只读取 `.env` 内的 `DEEPSEEK_API_KEY` / `AH32_OPENAI_API_KEY`，不会使用宿主环境的 `OPENAI_API_KEY`。

## 启动方式

### Python 启动脚本（推荐） ⭐

以下命令默认使用 `python start.py ...`；如未激活虚拟环境请改用：
- Linux/macOS：`.venv/bin/python start.py ...`
- Windows：`.venv\\Scripts\\python start.py ...`

```bash
# 仅启动后端（前台，Ctrl+C 退出）
python start.py -B

# 仅启动后端（后台常驻，推荐用于 Linux 服务器）
python start.py --daemon

# 查看后台状态 / 停止后台 / 跟踪后台日志
python start.py --status
python start.py --stop
python start.py --tail

# 启动后端 + 前端（仅当你的环境已安装 Node/npm）
python start.py -B -F

# 启动所有服务（后端 + 前端 + WPS 调试）
python start.py -B -F -D

# 追加/清空前台日志（logs/*.log）
python start.py -a
python start.py -c
```

**参数说明**：

- **服务参数**：
  - `-B`：启动后端服务（端口固定 `5123`）
  - `-F`：启动前端服务（Vite 默认 `3889`；Linux 下更建议手动 `npm -C ah32-ui-next run dev`）
  - `-D`：启动 WPS 调试（主要面向 Windows；Linux/macOS 通常用不到）

- **日志参数**：
  - `-a`：追加写入 `logs/*.log`
  - `-c`：清空 `logs/*.log`

- **后端后台常驻（Linux 推荐）**：
  - `--daemon`：后台启动后端（写入 PID/日志后退出命令行）
  - `--status`：查看后台运行状态
  - `--stop`：停止后台后端
  - `--tail`：跟踪后台日志

- **其他参数**：
  - `-h, --help`：显示帮助信息

**日志输出（与 Windows 尽量保持一致）**：

- 前台模式（`-B/-F/-D`）：写入 `logs/backend.log` / `logs/frontend.log` / `logs/wps.log`
- 后台常驻（`--daemon`）：写入 `logs/backend.nohup.log`，PID 写入 `logs/backend.pid`

**错误处理**：

- 单个服务启动失败不会影响其他服务
- 脚本会继续运行并显示错误信息
- 检查日志文件了解详细错误信息

### Windows 批处理

```bash
quick_start.bat
```

### 手动启动

```bash
# Linux/macOS（激活虚拟环境）
source .venv/bin/activate
python -m ah32.server.main

# Windows（激活虚拟环境）
.venv\Scripts\activate
python -m ah32.server.main

# 不激活虚拟环境也可以：
.venv/bin/python -m ah32.server.main          # Linux/macOS
.venv\Scripts\python -m ah32.server.main      # Windows
```

## 服务地址

- 后端 API: `http://<后端监听地址>:5123`（端口固定 `5123`）
- 前端界面: `http://127.0.0.1:3889`（使用 `-F` 或手动 `npm -C ah32-ui-next run dev`）

> 如果需要让其他机器访问后端（例如前端在另一台机器上），将仓库根目录 `.env` 里的
> `AH32_SERVER_HOST` 设为 `0.0.0.0`，并重启后端（`python start.py --stop && python start.py --daemon`）。
> 远程访问检查：`curl http://<服务器IP>:5123/health`。确保服务器防火墙/安全组放通 `5123/TCP`。
> 对外开放时建议开启鉴权：`AH32_ENABLE_AUTH=true` + 强随机 `AH32_API_KEY=...`。

## 日志文件

日志位置：`logs/`（本脚本输出），以及后端运行数据目录 `storage/`（向量库/上传/运行时数据）。

## 远程部署（前后端分离）注意事项

- 默认值：不配置时，后端会使用仓库/运行目录下的 `storage/` 与 `storage/memory/`。
- 持久化：远程部署请把 `AH32_STORAGE_ROOT` / `AH32_MEMORY_ROOT` 指到持久化目录（或挂载卷），避免重启丢 RAG 与会话记忆。
- Skills 默认目录（不配置时）：`<Documents>/Ah32/skills`（Windows/macOS/Linux 会自动取当前用户的 Documents；没有则回退到 home 目录）。
- RAG 三模式（自动选择最稳方案）：
  - 共享路径模式：后端能读到文件路径；远程时可用 `AH32_PATH_MAPPINGS` 做路径映射（例如 `Z:\\share=>/mnt/share;\\\\server\\share\\=>/mnt/share/`）。
  - 上传模式：当后端读不到客户端本地路径时，WPS 同步导入会自动提取文档文本并“上传入库”（不依赖共享盘）。
  - 目录导入：远程模式下依赖“共享路径/映射”；否则后端无法扫描客户端本地目录。

## 常见问题与故障排除

### 🚨 如果启动失败

**常见错误**：`OSError: [WinError 10106] 无法加载或初始化请求的服务提供程序`

**快速解决**：
```bash
# 使用修复版启动脚本（已自动禁用GPU和代理冲突）
python start.py
```

**详细故障排除**：请查看 [故障排除指南.md](./故障排除指南.md)

### 🔍 诊断步骤

1. **检查端口占用**
   ```bash
   # Windows:
   netstat -ano | findstr :5123
   # Linux:
   ss -ltnp | grep :5123
   ```

2. **检查环境变量**
   ```bash
   # Windows:
   echo %CUDA_VISIBLE_DEVICES%
   echo %HTTP_PROXY%
   # Linux:
   echo $CUDA_VISIBLE_DEVICES
   echo $HTTP_PROXY
   ```

3. **查看详细日志**
   ```bash
   # 后台常驻：
   tail -n 200 logs/backend.nohup.log
   # 前台模式：
   tail -n 200 logs/backend.log
   ```

4. **重启服务**
   ```bash
   python start.py --stop
   python start.py --daemon
   ```

### 📋 环境检查清单

- [ ] Python 3.11+ 已安装
- [ ] Node.js 18+ 已安装
- [ ] 虚拟环境已激活
- [ ] 依赖已安装 (`pip install -e .`)
- [ ] 端口 5123/3889 未被占用
- [ ] 网络连接正常

### 🛠️ 如果问题依然存在

请按以下顺序尝试：

1. **清理环境**
   ```bash
   # 重新安装依赖
   pip install --force-reinstall -e .

   # 清除代理设置
   set HTTP_PROXY=
   set HTTPS_PROXY=
   ```

2. **禁用GPU**
   ```bash
   set CUDA_VISIBLE_DEVICES=
   ```

3. **系统级修复**
   ```bash
   netsh winsock reset
   # 重启计算机
   ```

完整解决方案请参考：**故障排除指南.md**
