<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>阿蛤 - 智能助手</title>
</head>
<body>
  <div id="app"></div>
  <div id="boot-status" style="padding:12px;font-size:12px;color:#334155;font-family:Segoe UI, Arial, sans-serif;white-space:pre-wrap;">
    正在加载助手...
  </div>

  <!-- Optional runtime config (generated by installer / local deployment). -->
  <script src="config.js" onerror="try{console.warn('[taskpane] config.js not found')}catch(e){}"></script>

  <!-- 任务窗格错误捕获 - 便于白屏后定位原因 -->
  <script>
    (function () {
      var ERROR_KEY = 'ah32_last_error'
      var DIAG_KEY = 'ah32_reload_diag_v1'
      var overlayId = 'ah32-fatal-error-overlay'

      function _readLocalStorage(key) {
        try { return localStorage.getItem(key) } catch (e) { return '' }
      }

      function _readRuntimeConfig() {
        try {
          if (typeof window === 'undefined') return null
          return window.__AH32_CONFIG__ || null
        } catch (e) {
          return null
        }
      }

      function _resolveApiBase() {
        try {
          var cfg = _readRuntimeConfig()
          var fromCfg = cfg && cfg.apiBase ? String(cfg.apiBase || '').trim() : ''
          if (fromCfg && /^https?:\/\//i.test(fromCfg)) return fromCfg.replace(/\/+$/, '')

          var v = String(_readLocalStorage('ah32_api_base_v1') || '').trim()
          if (v && /^https?:\/\//i.test(v)) return v.replace(/\/+$/, '')
        } catch (e) {}
        return 'http://127.0.0.1:5123'
      }

      function _resolveApiKey() {
        try {
          var cfg = _readRuntimeConfig()
          var fromCfg = cfg && cfg.apiKey ? String(cfg.apiKey || '').trim() : ''
          if (fromCfg) return fromCfg
          return String(_readLocalStorage('ah32_api_key_v1') || '').trim()
        } catch (e) {
          return ''
        }
      }

      function reportTaskpaneError(scope, error, level) {
        var lv = level || 'warning'
        var msg = ''
        try {
          msg = (error && error.message) ? String(error.message) : String(error || '')
        } catch (e0) {
          msg = 'unknown error'
          try { console.warn('[taskpane] reportTaskpaneError parse failed', e0) } catch (e00) { console.error(e00) }
        }
        try { console.warn('[taskpane][' + String(scope || 'unknown') + ']', msg, error) } catch (e1) { console.error(e1) }
        try {
          if (typeof window !== 'undefined' && typeof window.__ah32_reportError === 'function') {
            window.__ah32_reportError('ah32-ui-next/taskpane.html:' + String(scope || 'unknown'), error, lv)
            return
          }
        } catch (e2) {
          try { console.warn('[taskpane] __ah32_reportError failed', e2) } catch (e22) { console.error(e22) }
        }
        try {
          var apiBase = _resolveApiBase()
          var url = apiBase + '/api/log?level=' + encodeURIComponent(lv) + '&message=' + encodeURIComponent('[taskpane][' + String(scope || 'unknown') + '] ' + msg)
          fetch(url, { method: 'GET' }).catch(function (e3) {
            try { console.warn('[taskpane] /api/log failed', e3) } catch (e33) { console.error(e33) }
          })
        } catch (e4) {
          try { console.warn('[taskpane] reportTaskpaneError fallback failed', e4) } catch (e44) { console.error(e44) }
        }
      }

      try {
        window.__ah32_reportTaskpaneError = reportTaskpaneError
      } catch (e5) {
        reportTaskpaneError('bind_global_reporter', e5, 'warning')
      }

      function safeJsonParse(text) {
        try { return JSON.parse(text) } catch (e) { return null }
      }

      function readJson(key) {
        try {
          return safeJsonParse(localStorage.getItem(key) || '') || null
        } catch (e) {
          return null
        }
      }

      function writeJson(key, value) {
        try {
          localStorage.setItem(key, JSON.stringify(value))
        } catch (e) { reportTaskpaneError('writeJson', e, 'warning') }
      }

      function getNavigationType() {
        try {
          var nav = performance && performance.getEntriesByType ? performance.getEntriesByType('navigation')[0] : null
          return nav && nav.type ? nav.type : 'unknown'
        } catch (e) {
          return 'unknown'
        }
      }

      function buildMessage(type, message, extra) {
        var time = new Date().toISOString()
        var detail = {
          type: type,
          message: message || '',
          extra: extra || '',
          time: time
        }
        try {
          localStorage.setItem(ERROR_KEY, JSON.stringify(detail))
        } catch (e) { reportTaskpaneError('buildMessage', e, 'warning') }
        return detail
      }

      function recordDiag(fields) {
        var diag = readJson(DIAG_KEY) || {}
        for (var k in fields) {
          diag[k] = fields[k]
        }
        writeJson(DIAG_KEY, diag)
        return diag
      }

      function recordCrash(type, message, extra) {
        var detail = buildMessage(type, message, extra)
        recordDiag({
          lastCrashAt: detail.time,
          lastCrashType: detail.type,
          lastCrashMessage: detail.message,
          lastCrashExtra: detail.extra
        })
        return detail
      }

      function renderLastDiag() {
        var boot = document.getElementById('boot-status')
        if (!boot) return

        var diag = readJson(DIAG_KEY)
        if (!diag) return

        // Only surface recent crashes/reloads; keep this lightweight.
        var parts = ['正在加载助手...']
        if (diag.lastUnloadAt) parts.push('上次退出: ' + diag.lastUnloadAt)
        if (diag.lastNavigationType) parts.push('上次导航: ' + diag.lastNavigationType)
        if (diag.lastCrashAt) {
          parts.push('上次异常: ' + diag.lastCrashAt)
          parts.push('异常类型: ' + (diag.lastCrashType || 'unknown'))
          parts.push('异常信息: ' + (diag.lastCrashMessage || ''))
        }

        // Avoid replacing an existing richer message (e.g. load failure notice).
        boot.textContent = parts.join('\n')
      }

      function showOverlay(detail) {
        try {
          if (document.getElementById(overlayId)) {
            return
          }
          var overlay = document.createElement('div')
          overlay.id = overlayId
          overlay.style.cssText = [
            'position:fixed',
            'inset:0',
            'background:#fff3f3',
            'color:#7f1d1d',
            'z-index:99999',
            'padding:16px',
            'font-family:Segoe UI, Arial, sans-serif',
            'font-size:12px',
            'line-height:1.5',
            'white-space:pre-wrap'
          ].join(';')
          var title = '⚠️ 任务窗格发生错误（请截图反馈）'
          var content = [
            title,
            '时间: ' + detail.time,
            '类型: ' + detail.type,
            '信息: ' + (detail.message || ''),
            detail.extra ? '详情: ' + detail.extra : ''
          ].filter(Boolean).join('\n')
          overlay.textContent = content
          document.body.appendChild(overlay)
        } catch (e) { reportTaskpaneError('showOverlay', e, 'error') }
      }

      // Track loads/unloads for "taskpane reload diagnosis".
      recordDiag({
        lastLoadAt: new Date().toISOString(),
        lastNavigationType: getNavigationType()
      })
      renderLastDiag()

      window.addEventListener('pagehide', function () {
        recordDiag({ lastUnloadAt: new Date().toISOString() })
      })

      window.addEventListener('error', function (event) {
        var stack = ''
        try {
          stack = event && event.error && event.error.stack ? String(event.error.stack) : ''
        } catch (e) {
          stack = ''
        }
        var extra = ''
        try {
          extra = JSON.stringify({
            href: location.href,
            filename: event && event.filename ? String(event.filename) : '',
            lineno: event && typeof event.lineno === 'number' ? event.lineno : null,
            colno: event && typeof event.colno === 'number' ? event.colno : null,
            stack: stack
          }).slice(0, 5000)
        } catch (e) {
          extra = stack
        }
        var detail = recordCrash(
          'error',
          event.message,
          extra
        )
        try {
          var apiBase = _resolveApiBase()
          var apiKey = _resolveApiKey()
          fetch(apiBase + '/agentic/error/report', {
            method: 'POST',
            headers: Object.assign({ 'Content-Type': 'application/json' }, apiKey ? { 'X-API-Key': apiKey } : {}),
            body: JSON.stringify({
              error_type: 'frontend_error',
              error_message: detail.message || event.message || '',
              error_code: '',
              correction_suggestion: '请截图并反馈给开发者（可在后台日志中追踪）。',
              user_context: JSON.stringify({ href: location.href, extra: detail.extra || '' }).slice(0, 5000),
              severity: 'high'
            })
          }).catch(function (e) { reportTaskpaneError('window.error.report.fetch', e, 'warning') })
        } catch (e) { reportTaskpaneError('window.error.report', e, 'warning') }
        showOverlay(detail)
        try {
          if (event && typeof event.preventDefault === 'function') {
            event.preventDefault()
          }
        } catch (e) { reportTaskpaneError('window.error.preventDefault', e, 'warning') }
      })

      window.addEventListener('unhandledrejection', function (event) {
        var reason = event.reason
        var message = reason && reason.message ? reason.message : String(reason)
        var extra = reason && reason.stack ? reason.stack : ''
        var detail = recordCrash('unhandledrejection', message, extra)
        try {
          var apiBase = _resolveApiBase()
          var apiKey = _resolveApiKey()
          fetch(apiBase + '/agentic/error/report', {
            method: 'POST',
            headers: Object.assign({ 'Content-Type': 'application/json' }, apiKey ? { 'X-API-Key': apiKey } : {}),
            body: JSON.stringify({
              error_type: 'frontend_unhandledrejection',
              error_message: message || '',
              error_code: '',
              correction_suggestion: '请截图并反馈给开发者（可在后台日志中追踪）。',
              user_context: JSON.stringify({ href: location.href, stack: extra || '' }).slice(0, 5000),
              severity: 'high'
            })
          }).catch(function (e) { reportTaskpaneError('unhandledrejection.report.fetch', e, 'warning') })
        } catch (e) { reportTaskpaneError('unhandledrejection.report', e, 'warning') }
        showOverlay(detail)
        try {
          if (event && typeof event.preventDefault === 'function') {
            event.preventDefault()
          }
        } catch (e) { reportTaskpaneError('unhandledrejection.preventDefault', e, 'warning') }
      })
    })()
  </script>

<!-- WPS 桥接脚本 - v3.5 -->
  <script src="js/util.js"></script>
  <script src="js/ribbon.js"></script>

  <!-- 脚本加载验证 - v3.5 -->
  <script>
    console.log('[任务窗格 v3.5] 脚本加载检查')

    // 检查并确保 ribbon 对象存在
    if (!window.ribbon) {
      console.log('[任务窗格 v3.5] 初始化 ribbon 对象...')
      window.ribbon = {
        OnAddinLoad: function(ribbonUI) {
          if (typeof (window.Application.ribbonUI) != "object") {
            window.Application.ribbonUI = ribbonUI;
          }
          if (typeof (window.Application.Enum) != "object") {
            window.Application.Enum = window.WPS_Enum || {}
          }
          window.Application.PluginStorage.setItem("ah32_taskpane_id", "")
          return true
        },
        OnAction: function(control) {
          if (control.Id === "btnOpenPanel") {
            const taskpane = OpenTaskPane(GetUrlPath() + "/taskpane.html", "阿蛤智能助手")
          }
          return true
        },
        GetImage: function(control) {
          var baseUrl = ""
          try { baseUrl = String(GetUrlPath() || "") } catch (e) { baseUrl = "" }

          var rel = "assets/newFromTemp.svg"
          switch (control.Id) {
            case "btnOpenPanel": rel = "assets/1.svg"; break
            case "btnReadDoc": rel = "assets/2.svg"; break
            case "btnWriteDoc": rel = "assets/3.svg"; break
            default: rel = "assets/newFromTemp.svg"; break
          }

          if (baseUrl && /^https?:\/\//i.test(baseUrl)) {
            return baseUrl.replace(/\/+$/, "") + "/" + rel.replace(/^\/+/, "")
          }
          return rel.replace(/^\/+/, "")
        },
        OnGetEnabled: function() { return true },
        OnGetVisible: function() { return true },
        OnGetLabel: function(control) {
          return control.Id === "btnOpenPanel" ? "打开助手" : ""
        }
      }
      console.log('[任务窗格 v3.5] ✅ ribbon 对象已初始化')
    }
  </script>
  

  <!--
    加载策略（稳定优先）：
    - 优先加载本地打包产物：./assets/main.js（无热加载；适合跑宏基准/长任务，避免任务窗格闪断）
    - 若本地 bundle 不存在（例如开发调试），再回退到 Vite dev server：
      http://127.0.0.1:3889/src/main.ts
    - 默认不加载 /@vite/client（禁用 HMR）；如需开启，请在 ah32-ui-next/.env 配置 VITE_ENABLE_HMR=true 并重启 dev server
  -->
  <script>
    (function () {
      function loadScript(src, type) {
        return new Promise(function (resolve, reject) {
          var el = document.createElement('script')
          if (type) {
            el.type = type
          }
          el.src = src
          el.onload = function () { resolve(true) }
          el.onerror = function () { reject(new Error('Failed to load: ' + src)) }
          document.head.appendChild(el)
        })
      }

      function loadProd() {
        // Vite build outputs to `./assets/main.js` (IIFE). This has no hot-reload and is more stable in WPS.
        return loadScript('./assets/main.js')
      }

      function loadDev() {
        // Prefer the same host (some WPS debug servers use localhost instead of 127.0.0.1).
        // Note: when taskpane is loaded via file://, fall back to the loopback host.
        var host = (location && location.hostname) ? String(location.hostname) : '127.0.0.1'
        var proto = (location && /^https?:$/.test(String(location.protocol))) ? String(location.protocol) : 'http:'
        var base = proto + '//' + host + ':3889'
        var hmrFlag = String('%VITE_ENABLE_HMR%').trim().toLowerCase()
        var wantsHmr = (hmrFlag === '1' || hmrFlag === 'true' || hmrFlag === 'yes')
        var tasks = []
        if (wantsHmr) {
          tasks.push(loadScript(base + '/@vite/client', 'module'))
        }
        tasks.push(loadScript(base + '/src/main.ts', 'module'))
        return Promise.all(tasks)
      }

      // Stable by default: try local bundle first, then fall back to dev server.
      loadProd()
        .catch(function () { return loadDev() })
        .catch(function (err) {
          try {
            var msg = (err && err.message) ? err.message : String(err)
            console.error('[taskpane] frontend bootstrap failed:', msg)
            var boot = document.getElementById('boot-status')
            if (boot) {
              boot.textContent = [
                '⚠️ 助手加载失败：无法加载前端资源。',
                '如需稳定模式：运行 npm -C ah32-ui-next run build（并重新安装/刷新插件）。',
                '如需开发调试：运行 npm -C ah32-ui-next run dev（端口 3889）。',
                '错误: ' + msg
              ].join('\\n')
            }

            // Best-effort: report to backend for later tracing.
            var apiBase = _resolveApiBase()
            var apiKey = _resolveApiKey()
            fetch(apiBase + '/agentic/error/report', {
              method: 'POST',
              headers: Object.assign({ 'Content-Type': 'application/json' }, apiKey ? { 'X-API-Key': apiKey } : {}),
              body: JSON.stringify({
                error_type: 'frontend_bootstrap_error',
                error_message: msg,
                error_code: '',
                correction_suggestion: '请确认前端资源可加载（build 或 dev server），并截图反馈。',
                user_context: JSON.stringify({ href: location.href }).slice(0, 5000),
                severity: 'high'
              })
            }).catch(function (e) { reportTaskpaneError('bootstrap.report.fetch', e, 'warning') })
          } catch (e) { reportTaskpaneError('bootstrap.report', e, 'warning') }
        })
    })()
  </script>

  <!-- 启动检测与白屏兜底 -->
  <script>
    (function () {
      var READY_KEY = '__AH32_APP_READY__'
      var app = document.getElementById('app')
      var boot = document.getElementById('boot-status')

      function hideBoot() {
        if (boot) {
          boot.style.display = 'none'
        }
      }

      function showBoot(text) {
        if (boot) {
          boot.textContent = text
          boot.style.display = 'block'
        }
      }

      function checkMounted() {
        if (window[READY_KEY] || (app && app.childElementCount > 0)) {
          hideBoot()
          return true
        }
        return false
      }

      setTimeout(function () {
        if (!checkMounted()) {
          showBoot('⚠️ 助手加载失败，请检查 Vite 服务是否运行并保持连接。')
        }
      }, 5000)

      if (app && typeof MutationObserver !== 'undefined') {
        var observer = new MutationObserver(function () {
          if (app.childElementCount === 0) {
            showBoot('⚠️ 助手页面已被清空，请截图反馈。')
          } else {
            hideBoot()
          }
        })
        observer.observe(app, { childList: true })
      }
    })()
  </script>

  <!-- 任务窗格初始化脚本（已移除） -->
  <!--
    说明：
    - 旧版会尝试调用 window.initializeDocumentListeners() 初始化文档事件监听。
    - 当前前端架构使用手动刷新/事件驱动（无该全局函数），保留只会产生误导性的“初始化失败”日志。
  -->
</body>
</html>
