# TODO: Writer(WPS) Agentic 智能文档处理计划

## 背景
Writer 操作不应是简单的"点击工具栏"，而是通过 **Agentic 对话** 让 AI 理解用户的文档处理需求，自动生成 Plan 完成文档编辑、排版、润色等工作。

---

## 核心理念

**用户需求** → **AI 理解文档结构** → **AI 决策操作** → **自动生成 Plan 执行** → **结果呈现**

---

## 落地现状（2026-02-20）

这份文档偏“愿景规划”。以当前代码为准：
- ✅ 已有 `ah32.plan.v1` + `host_app=wps` 的可执行闭环（块级写回 + 定位插入 + 基础样式）。
- ✅ 已补“可控的排版原语”：
  - 块内：`set_paragraph_format` / `set_writer_table_style`（建议限定在 `block_id` 或当前选区，避免全篇乱改）
  - 全篇/选区：`apply_paragraph_style` / `normalize_headings`（deterministic 遍历；同样支持 `block_id` 或 selection 限定）
- ❌ 仍未实现：真正的“文档结构理解”（标题层级/列表/表格检测等）对应的 deterministic 扫描工具与默认技能闭环（目前更多是能力清单/规划）。

---

## 阶段一：现有操作（已实现）

### 1.1 基础操作
```
set_selection              ✅ 设置光标位置
insert_text                ✅ 插入文本
insert_after_text          ✅ 在指定文本后插入
insert_before_text         ✅ 在指定文本前插入
insert_table              ✅ 插入表格
insert_chart_from_selection ✅ 插入图表
insert_word_art           ✅ 插入艺术字
set_text_style            ✅ 设置文本样式
set_paragraph_format      ✅ 设置段落格式（支持 block_id 限定到 upsert_block 内）
apply_text_style_to_matches ✅ 批量匹配并应用样式（支持 block_id 限定到 upsert_block 内，避免全篇乱改）
set_writer_table_style    ✅ 表格样式（建议 block_id/选区限定，避免全篇遍历）
answer_mode_apply         ✅ 问答模式应用
upsert_block              ✅ 插入/更新块
delete_block              ✅ 删除块
```

---

## 阶段二：Agentic 能力扩展

### 2.1 文档结构理解

| 能力 | 描述 | 实现方式 |
|------|------|----------|
| 标题层级识别 | 自动识别文档标题结构 | 分析段落样式 |
| 列表识别 | 识别有序/无序列表 | 检测格式标记 |
| 表格检测 | 检测文档中表格位置 | 扫描表格对象 |
| 图表检测 | 检测文档中图表 | 扫描图形对象 |
| 章节分割 | 识别文档章节边界 | 基于标题层级 |

### 2.2 智能内容处理

| 能力 | 描述 | Plan Op |
|------|------|---------|
| 智能润色 | 改写、优化文本内容 | insert_after_text + set_text_style |
| 标题格式化 | 统一标题样式 | set_text_style + 遍历段落 |
| 列表转换 | 文本转列表/列表转文本 | insert_text + 格式设置 |
| 表格美化 | 优化表格样式（建议限定在 `block_id` 或当前选区，避免全篇遍历） | set_writer_table_style |
| 图表说明 | 自动添加图注 | insert_after_text |

---

## 阶段三：Skill 设计

### 3.1 doc-formatter Skill

**目标**：智能格式化文档

**输入**：
- 用户需求（"帮我排版"、"统一格式"）
- 当前文档内容

**输出**：
- 格式调整 Plan

**能力**：
- 标题样式统一
- 段落间距调整
- 列表格式化
- 表格美化

### 3.2 doc-editor Skill

**目标**：智能编辑文档

**输入**：
- 用户需求（"帮我改写"、"添加内容"）
- 当前文档内容

**输出**：
- 编辑操作 Plan

**能力**：
- 文本润色
- 段落重排
- 内容摘要
- 关键词提取

### 3.3 doc-analyzer Skill

**目标**：分析文档结构

**输入**：
- 当前文档

**输出**：
- 文档结构报告
- 格式建议 Plan

---

## 阶段四：典型场景

### 场景1：文档排版
```
用户："帮我把这份文档排版得好看一点"

AI 理解：
- 识别标题层级
- 识别列表、表格
- 规划格式调整

Plan 生成：
1. set_selection（定位到开头）
2. set_text_style（标题1样式）
3. set_text_style（标题2样式）
4. insert_text（调整段落间距）
5. set_writer_table_style（美化表格）
```

### 场景2：内容润色
```
用户："把这段话改得更专业一点"

AI 理解：
- 分析原文内容
- 生成润色版本

Plan 生成：
1. set_selection（定位到目标段落）
2. insert_after_text（插入润色后文本）
3. delete_block（删除原文）
```

---

## 实现顺序

1. **doc-formatter Skill** - 格式调整
2. **文档理解增强** - 结构识别
3. **doc-editor Skill** - 内容编辑
4. **doc-analyzer Skill** - 结构分析

---

## 技术要点

1. **结构感知**：通过 WPS JSAPI 读取文档结构
2. **智能决策**：根据用户需求选择合适操作
3. **自动执行**：生成完整 Plan，一次性执行

---

## 阶段五：高级智能能力（思维链/思维树/规划/迭代）

### 5.1 思维链（Chain of Thought）

让 AI 在生成 Plan 前展示推理过程：

```json
{
  "meta": {
    "reasoning": [
      "1. 分析用户需求：需要将文档排版得专业",
      "2. 扫描文档结构：发现3级标题，5个表格，12个段落",
      "3. 规划操作序列：先统一标题样式 → 再美化表格 → 最后调整段落间距",
      "4. 生成 Plan：共需要15个操作"
    ]
  }
}
```

**实现方式**：
- 在 SYSTEM.md 中要求 AI 输出 reasoning 字段
- 前端展示推理过程供用户确认
- 用户可干预修改 Plan

### 5.2 思维树（Tree of Thought）

探索多种方案，选择最优：

```json
{
  "meta": {
    "alternatives": [
      {
        "方案A": "全部手动调整样式，适合精细控制",
        "方案B": "应用主题快速统一，适合大面积修改",
        "方案C": "混合方案，标题用主题，正文手动微调"
      },
      "推荐方案C，平衡效率与效果"
    ]
  }
}
```

**实现方式**：
- 要求 AI 生成 2-3 个备选方案
- 每个方案包含：操作列表、预期效果、耗时
- 用户选择后执行

### 5.3 规划能力（Planning）

复杂任务自动分解为多步骤：

```
用户："帮我写一份产品介绍文档，包含封面、简介、功能、定价"

分解为：
├── 阶段1：创建文档框架
│   ├── 添加封面页
│   └── 添加目录
├── 阶段2：编写内容
│   ├── 添加产品简介
│   ├── 添加功能列表
│   └── 添加定价信息
└── 阶段3：美化排版
    ├── 统一标题样式
    └── 添加装饰元素
```

**实现方式**：
- Plan 支持嵌套阶段（phase/step）
- Executor 按阶段执行，支持暂停确认

### 5.4 持续迭代（Iterative Execution）

执行→检查→调整→继续：

```
执行循环：
├── Step 1: 插入标题 → 检查效果 ✓
├── Step 2: 插入表格 → 检查格式 → 调整列宽 ✓
├── Step 3: 添加图表 → 检查位置 → 移动位置 ✓
└── 完成
```

**实现方式**：
- Executor 返回每步执行结果
- AI 检查结果是否达到预期
- 偏差 > 阈值时自动调整后续操作

---

## 实现顺序

### 阶段规划

| 阶段 | 内容 | 优先级 |
|------|------|--------|
| 阶段一 | 现有基础操作 | 已完成 |
| 阶段二 | Agentic 能力扩展 | P1 |
| 阶段三 | Skill 设计 | P1 |
| 阶段四 | 典型场景 | P2 |
| 阶段五 | 思维链/思维树/规划/迭代 | P2/P3 |

### 阶段五细分

| 阶段 | 内容 | 优先级 |
|------|------|--------|
| 5.1 | 思维链（reasoning 字段） | P2 |
| 5.2 | 思维树（alternatives 字段） | P2 |
| 5.3 | 规划能力（phase/step 嵌套） | P3 |
| 5.4 | 持续迭代（执行-检查-调整） | P3 |
